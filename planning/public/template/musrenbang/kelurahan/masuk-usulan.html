<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title"><i class="mdi mdi-clipboard-outline"></i> Masukkan Usulan</h4>
                <hr>
                <div class="row">
                    <div class="table-responsive ml-3 mr-3" style="overflow: auto;">
                    	<div id="alert">
                            
                        </div>
                        <button class="btn btn-outline-success mb-2" onclick="initTambah()" data-toggle="modal" data-target="#modal-tambah"><i class="mdi mdi-plus-box-outline"></i> Tambah Usulan</button>
	                    <table id="zero_config" class="table table-striped table-bordered table-hover">
	                        <thead>
	                            <tr class="text-white" style="background-color: #4fc3f7">
	                                <th>Nama Usulan</th>
	                                <th>Alasan Usulan</th>
	                                <th>Volume Usulan</th>
	                                <th>Satuan Usulan</th>
	                                <th>Pagu Anggaran</th>
	                                <th>Penerima Manfaat</th>
	                                <th>Nama Pengusul</th>
	                                <th>Kategori</th>
	                                <th width="170" class="text-center">File</th>
	                                <th class="text-center" width="160">Menu</th>
	                            </tr>
	                        </thead>
	                        <tbody id="data-table">
	                           
	                        </tbody>
	                    </table>
	                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- sample modal content -->
<div class="modal fade" id="modal-tambah" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h4 class="modal-title" id="myLargeModalLabel"><i class="mdi mdi-plus-box-outline"></i> <span id="judul-modal"></span></h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            </div>
            <form id="tambah_usulan" action="" enctype="multipart/form-data">
            <div class="modal-body">
            <div class="row">
            <div class="col-md-6 col-xs-12">
                <div class="form-group">
                    <label>Nama Usulan <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="nama" id="nama" required>
                    <!-- <small class="form-text text-muted"> with anyone else.</small> -->
                </div>
                <div class="form-group">
                    <label>Alasan Usulan <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="alasan" id="alasan" required>
                </div>
                <div class="form-group">
                    <label>Lokasi Detail <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="lokasi" id="lokasi" required>
                </div>
                <div class="form-group">
                    <label>Volume Usulan <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="volume" id="volume" required>
                </div>
                <div class="form-group">
                    <label>Satuan Usulan <span class="text-danger">*</span></label>
                    <select class="form-control" name="satuan" id="satuan" required>
                    	
                    </select>
                </div>
            </div>
            <input type="hidden" name="id_grub" id="id_grub">
            <input type="hidden" name="id_usulan" id="id_usulan">
            <input type="hidden" name="level" id="levelx">
            <div class="col-md-6 col-xs-12">
                <div class="form-group">
                    <label>Kategori <span class="text-danger">*</span></label>
                    <select class="form-control" name="kategori" id="kategori" required>
                    	
                    </select>
                </div>
                <div class="form-group">
                    <label>Pagu Anggaran <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="aggaran" id="aggaran" required>
                </div>
                <div class="form-group">
                    <label>Penerima Manfaat <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="penerima" id="penerima" required>
                </div>
                <div class="form-group">
                    <label>Nama Pengusul <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="pengusul" id="pengusul" required>
                </div>
                <div class="form-group">
                    <label>Upload Foto <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="inputGroupFileAddon01">Upload</span>
                        </div>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="foto" name="foto">
                            <label class="custom-file-label" for="inputGroupFile01">Pilih file</label>
                        </div>
                    </div>
                    <span class="text-info" id="info"></span>
                </div>
            </div>
            </div>
            </div>
            <div class="modal-footer">
            	<button type="submit" class="btn btn-success" id="btn-modal"><i class="fa fa-save"></i> Simpan</button>
                <button type="reset" class="btn btn-danger waves-effect">Reset</button>
            </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<!-- sample modal content -->
<div class="modal fade" id="modal-gambar" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
            	<div class="row">
                    <div class="col-md-12">
                        <img src="" class="img img-responsive" id="tampil_gambar" alt="Gambar" width="100%">
                    </div>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<script type="text/javascript">
    if (idUsul == false) {
        $('#alert').html('<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button><i class="fa fa-exclamation-triangle"></i> Periksa/Pilih Usulan Terlebih Dahulu</div>')
    }
    else{
        getData();
        $('#id_grub').val(idUsul);
    }

    getProperti('satuan');
    getProperti('kategori');
    $('#levelx').val(level);

	$(".custom-file-input").on("change",function(){
		var e = $(this).val();
		$(this).next(".custom-file-label").html(e);
	});

    function getData(){
      var url = config.apiRoot+link+'getAllUsulan';
      //loading();
      return $.ajax({
        type: "POST",
        url: url,
        dataType: "JSON",
        data: {
          id_user: dataSession.id_user,
          level: level,
          idUsul: idUsul,
          session: getCookie('codexv-session')
        },
        success: function(respon)
        {   
          //setDataAll(respon);
          // dataAll = respon.data;
          inputData(respon.data);
          // console.log(respon);
          //loading(false);
        },
        error:function(error){
          console.log(error);
          //loading(false);
        }
      });
    }

    function inputData(data){
        i = 1;
        let setId;
        let row
        data.forEach(element => {
          setId = element.id_tb_musrenbang_kel;
          row += '<tr>'+
                  '<td>'+element.tb_musrenbang_kel_nama+'</td>'+
                  '<td>'+element.tb_musrenbang_kel_alasan+'</td>'+
                  '<td>'+element.tb_musrenbang_kel_volume+'</td>'+
                  '<td>'+element.tb_satuan_nama +'</td>'+
                  '<td>'+element.tb_musrenbang_kel_pagu+'</td>'+
                  '<td>'+element.tb_musrenbang_kel_manfaat+'</td>'+
                  '<td>'+element.tb_musrenbang_kel_pengusul+'</td>'+
                  '<td>'+element.tb_indikator_nama+'</td>'+
                  '<td><div class="row"><div class="col-md-12"><button class="btn btn-info btn-block" data-toggle="modal" data-target="#modal-gambar" onclick="initGambar(this)" data-foto="'+config.apiRoot+element.tb_musrenbang_kel_file_foto+'"> <i class="fa fa-images"></i> Foto</button></div>';

                  if (element.tb_musrenbang_kel_file_ba != '') {
                    row += '<div class="col-md-12 mt-1"><a class="btn btn-info btn-block" href="'+config.apiRoot+element.tb_musrenbang_kel_file_ba+'" download> <i class="fa fa-file-pdf"></i> Berita Acara</a></div>';
                  }

                  if (element.tb_musrenbang_kel_file_usulan != '') {
                    row += '<div class="col-md-12 mt-1"><a class="btn btn-info btn-block" href="'+config.apiRoot+element.tb_musrenbang_kel_file_usulan+'" download> <i class="fa fa-file-pdf"></i> Usulan</a></div></div>';
                  }
                  row += '</td><td class="text-center"><button class="btn btn-warning" onclick="initEdit(this)" id="'+setId+'"><i class="fa fa-edit"></i> Edit</button> <button class="btn btn-danger" onclick="initHapus(this)" id="'+setId+'"><i class="fa fa-trash"></i> Hapus</button></td>'+
                '</tr>';
          i++;
        });
        $("#zero_config").dataTable().fnDestroy();
        $("#data-table").empty();
        $("#data-table").append(row);
        $('#zero_config').DataTable({
          'ordering': false
        });
    }

	function initHapus(obj){
		Swal.fire({
            title: 'Apakah data akan dihapus?',
            text: "Data yang terhapus tidak dapat dikembalikan",
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            cancelButtonText: 'Batal',
            confirmButtonText: 'Ya, hapus!'
        }).then((result) => {
            if (result.value) {
                var idx = $(obj).attr('id');
                doDelete(idx);
                Swal.fire(
                    'Terhapus!',
                    'Data berhasil dihapus.',
                    'success'
                )
            }
        })
	}

    function doDelete(id){
        var url = config.apiRoot+link+'hapusUsulan';
        $.ajax({
            url: url,
            type: "POST",
            dataType: "JSON",
            data: {id_usulan: id, level: level},
            success: function(r){
                console.log(r);
                getData();
            },
            error: function(e){
                console.log(e);
            }      
        });
    }

    function bersih(){
        $('#tambah_usulan').trigger("reset");
        $(".custom-file-label").html('Pilih File');
    }

    function initGambar(obj){
        var gbr = $(obj).attr('data-foto');
        $('#tampil_gambar').attr('src', gbr);
    }

    function initTambah(){
        bersih();
        $('#judul-modal').html('Tambah Usulan');
        $("#tambah_usulan").attr("action", config.apiRoot+link+'masukUsulan');
        $('.modal-header').removeClass('bg-success, bg-warning');
        $('.modal-header').addClass('bg-success');
        $('#btn-modal').removeClass('btn-success, btn-warning');
        $('#btn-modal').addClass('btn-success');
        $('#foto').attr('required', 'true');
        $('#info').html('');
    }

    function initEdit(obj){
        bersih();
        $('#judul-modal').html('Edit Usulan');
        $("#tambah_usulan").attr("action", config.apiRoot+link+'editUsulan');
        $('.modal-header').removeClass('bg-success, bg-warning');
        $('.modal-header').addClass('bg-warning');
        $('#btn-modal').removeClass('btn-success, btn-warning');
        $('#btn-modal').addClass('btn-warning');
        $('#foto').removeAttr('required');
        $('#info').html('Kosongkan jika tidak ingin diubah');
        var id_usulan = $(obj).attr('id');
        var dataKirim = {id_usulan: id_usulan, level: level};
        var url = config.apiRoot+link+'getUsulanById';
        $.when(sendAjax(url, dataKirim)).done(function(r){
            $.when(isiNilai(r)).done(function(x){
                $('#modal-tambah').modal('show');
            });
        });
    }

    function isiNilai(data){
        $('#id_usulan').val(data.id_tb_musrenbang_kel);
        $('#nama').val(data.tb_musrenbang_kel_nama);
        $('#alasan').val(data.tb_musrenbang_kel_alasan);
        $('#lokasi').val(data.tb_musrenbang_kel_lokasi);
        $('#volume').val(data.tb_musrenbang_kel_volume);
        $('#satuan').val(data.id_tb_satuan);
        $('#kategori').val(data.id_tb_indikator);
        $('#aggaran').val(data.tb_musrenbang_kel_pagu);
        $('#penerima').val(data.tb_musrenbang_kel_manfaat);
        $('#pengusul').val(data.tb_musrenbang_kel_pengusul);
    }

    $("#tambah_usulan").on('submit', function(e){
        e.preventDefault();
        if (idUsul == false) {
            $('#modal-tambah').modal('hide');
            $('#alert').html('<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button><i class="fa fa-exclamation-triangle"></i> Periksa/Pilih Usulan Terlebih Dahulu</div>');
        }
        else{
            var url = $(this).attr('action');
            $.ajax({
                url: url,
                type: "POST",
                data: new FormData(this),
                dataType: "JSON",
                contentType: false,
                cache: false,
                processData:false,
                success: function(r){
                    if (r.data == 0) {
                        $('#alert').html('<div class="alert alert-danger"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button><i class="fa fa-exclamation-triangle"></i> File foto tidak valid. Penyimpanan dibatalkan!</div>');
                    }
                    else{
                        $('#alert').html('<div class="alert alert-success"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button><i class="fa fa-check"></i> Penyimpanan berhasil</div>');
                    }
                    console.log(r);
                    getData();
                    bersih();
                },
                error: function(e){
                    console.log(e);
                }          
            });
            $('#modal-tambah').modal('hide');
        }
    });

    function getProperti(target = ''){
      var url = config.apiRoot+link+target;
      return $.ajax({
        type: "POST",
        url: url,
        dataType: "JSON",
        data: {},
        success: function(respon)
        {   
          setProperti(respon, target);
          //console.log(respon);
        },
        error:function(error){
          console.log(error);
        }
      })
   }

   function setProperti(data, target = ''){
    $('#'+target).html('');
    if (target == 'satuan') {
       var row = '<option value="">-- Pilih Satuan --</option>';
       data.forEach(element => {
          row += '<option value="'+element.id_tb_satuan+'">'+element.tb_satuan_nama+'</option>';
       });
    }
    else{
       var row = '<option value="">-- Pilih Kategori --</option>';
       data.forEach(element => {
          row += '<option value="'+element.id_tb_indikator+'">'+element.tb_indikator_nama+'</option>';
       });
    }
    $('#'+target).append(row);
    $('#'+target).val();
   }
</script>